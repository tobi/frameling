#!/bin/bash
# Combined CPU/GPU Temperature and Power Profile script for Waybar with history tracking

HISTORY_FILE="/tmp/waybar_temp_history"
THROTTLE_FILE="/tmp/waybar_throttle_history"
MAX_HISTORY_MINUTES=5

# Get current timestamp
current_time=$(date +%s)

# Get CPU temperature
cpu_temp=$(cat /sys/class/thermal/thermal_zone0/temp 2>/dev/null || echo "0")
cpu_temp=$((cpu_temp / 1000))

# Get GPU temperature (optimized)
gpu_temp=""
for hwmon in /sys/class/drm/card*/device/hwmon/hwmon*/temp1_input; do
    if [ -f "$hwmon" ]; then
        temp=$(cat "$hwmon" 2>/dev/null)
        if [ -n "$temp" ] && [ "$temp" -gt 0 ]; then
            gpu_temp=$((temp / 1000))
            break
        fi
    fi
done

# Fallback GPU temp from sensors if hwmon failed
if [ -z "$gpu_temp" ] && command -v sensors >/dev/null 2>&1; then
    gpu_temp=$(sensors 2>/dev/null | grep -m1 -E "(junction|edge)" | sed -n 's/.*+\([0-9.]*\)°C.*/\1/p' | cut -d'.' -f1)
fi

# Get current power profile
power_profile=$(powerprofilesctl get 2>/dev/null || echo "unknown")

# Get power profile name
case "$power_profile" in
    "power-saver")
        profile_name="Power Saver"
        ;;
    "balanced")
        profile_name="Balanced"
        ;;
    "performance")
        profile_name="Performance"
        ;;
    *)
        profile_name="Unknown"
        ;;
esac

# Check for thermal throttling (AMD systems)
if [ -d "/sys/devices/system/cpu/cpu0/thermal_throttle" ]; then
    # Check if any CPU core has been throttled in the last minute
    for cpu in /sys/devices/system/cpu/cpu*/thermal_throttle/core_throttled_time; do
        if [ -f "$cpu" ]; then
            throttle_time=$(cat "$cpu" 2>/dev/null || echo "0")
            if [ "$throttle_time" -gt 0 ]; then
                throttled_recently=true
                break
            fi
        fi
    done
fi

# Store temperature history
echo "$current_time $cpu_temp $gpu_temp $throttled_recently" >> "$HISTORY_FILE"

# Clean old entries (older than MAX_HISTORY_MINUTES)
cutoff_time=$((current_time - MAX_HISTORY_MINUTES * 60))
temp_file=$(mktemp)
awk -v cutoff="$cutoff_time" '$1 >= cutoff' "$HISTORY_FILE" > "$temp_file"
mv "$temp_file" "$HISTORY_FILE"

# Calculate 5-minute max values
if [ -f "$HISTORY_FILE" ]; then
    cpu_max=$(awk 'NR==1{max=$2} $2>max{max=$2} END{print max}' "$HISTORY_FILE")
    gpu_max=$(awk 'NR==1{max=$3} $3>max{max=$3} END{print max}' "$HISTORY_FILE")
else
    cpu_max=$cpu_temp
    gpu_max=$gpu_temp
fi

# Check if this is being called for icon-only mode
if [ "$1" = "icon" ]; then
    # Use the CPU icon for all profiles
    profile_icon="󰍛"

    # Determine color based on power profile
    case "$power_profile" in
        "power-saver")
            color="#22c55e"  # green
            ;;
        "performance")
            color="#eab308"  # yellow
            ;;
        *)
            color=""  # default
            ;;
    esac

    # Apply color using Pango markup if color is set
    if [ -n "$color" ]; then
        profile_icon="<span color='$color'>$profile_icon</span>"
    fi

    # Show the CPU icon with tooltip including temperatures and profile
    tooltip="CPU: $cpu_temp°C\\n"
    tooltip+="GPU: ${gpu_temp:-N/A}°C\\n"
    tooltip+="Profile: $profile_name"

    echo "{\"text\": \"$profile_icon\", \"tooltip\": \"$tooltip\"}"
    exit 0
fi

# Always show temperatures with compact format
cpu_display="${cpu_temp}°C"
gpu_display="${gpu_temp:-N/A}°C"

# Use the CPU icon for all profiles
profile_icon="󰍛"

# Determine color based on temperature (red for hot, yellow for warm, green for cool)
if [ "$cpu_temp" -ge 80 ] || [ "$gpu_temp" -ge 80 ]; then
    color="#ef4444"  # red for hot
elif [ "$cpu_temp" -ge 70 ] || [ "$gpu_temp" -ge 70 ]; then
    color="#f97316"  # orange for warm
elif [ "$cpu_temp" -ge 60 ] || [ "$gpu_temp" -ge 60 ]; then
    color="#eab308"  # yellow for moderate
else
    color="#22c55e"  # green for cool
fi

# Apply color using Pango markup
profile_icon="<span color='$color'>$profile_icon</span>"

# Build tooltip with values and power profile
tooltip="CPU: $cpu_temp°C (5min max: ${cpu_max}°C)\\n"
tooltip+="GPU: ${gpu_temp:-N/A}°C (5min max: ${gpu_max:-N/A}°C)\\n"
tooltip+="Profile: $profile_name"

# Add throttling warning if applicable
if [ "$throttled_recently" = true ]; then
    tooltip+="\\n\\n⚠️  Thermal throttling detected recently"
    # Override color for throttling warning
    profile_icon="<span color='#ff4444'>$profile_icon</span>"
fi

echo "{\"text\": \"CPU:$cpu_display GPU:$gpu_display $profile_icon\", \"tooltip\": \"$tooltip\"}"