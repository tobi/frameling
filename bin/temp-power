#!/bin/bash
# Combined CPU/GPU Temperature and Power Profile script for Waybar

# Get CPU temperature
cpu_temp=$(cat /sys/class/thermal/thermal_zone0/temp 2>/dev/null || echo "0")
cpu_temp=$((cpu_temp / 1000))

# Get GPU temperature (optimized)
gpu_temp=""
for hwmon in /sys/class/drm/card*/device/hwmon/hwmon*/temp1_input; do
    if [ -f "$hwmon" ]; then
        temp=$(cat "$hwmon" 2>/dev/null)
        if [ -n "$temp" ] && [ "$temp" -gt 0 ]; then
            gpu_temp=$((temp / 1000))
            break
        fi
    fi
done

# Fallback GPU temp from sensors if hwmon failed
if [ -z "$gpu_temp" ] && command -v sensors >/dev/null 2>&1; then
    gpu_temp=$(sensors 2>/dev/null | grep -m1 -E "(junction|edge)" | sed -n 's/.*+\([0-9.]*\)°C.*/\1/p' | cut -d'.' -f1)
fi

# Get current power profile
power_profile=$(powerprofilesctl get 2>/dev/null || echo "unknown")

# Only show if either temperature is 50°C or above
if [ "$cpu_temp" -ge 50 ] || [ "$gpu_temp" -ge 50 ]; then
    # Format temperatures (handle missing GPU temp)
    cpu_display="${cpu_temp}°C"
    gpu_display="${gpu_temp:-N/A}°C"

    # Capitalize first letter of power profile
    profile_display="$(echo "$power_profile" | sed 's/power-saver/Power Saver/; s/balanced/Balanced/; s/performance/Performance/')"

    echo "{\"text\": \"CPU:$cpu_display GPU:$gpu_display [$profile_display]\", \"tooltip\": \"CPU: $cpu_temp°C\\nGPU: ${gpu_temp:-N/A}°C\\nProfile: $profile_display\"}"
else
    # Hide the module when temperatures are low
    echo "{\"text\": \"\", \"tooltip\": \"\"}"
fi